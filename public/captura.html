<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Captura de Reporte Diario</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f6f6f6; }
    h1 { margin-bottom: 5px; }
    .muted { opacity: .7; font-size: 13px; }
    .box { background: white; padding: 16px; border-radius: 10px; margin-top: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    label { font-size: 13px; opacity: .8; display:block; margin-top: 10px; }
    input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    button { background: #0b5; color: white; font-weight: bold; cursor: pointer; border: none; margin-top: 14px; }
    button:hover { background: #0a4; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 180px; }
    pre { background: #111; color: #0f0; padding: 12px; border-radius: 10px; overflow:auto; }
    .danger { color: #b00; font-weight: bold; }
    .totalBox { background:#f0fff5; border:1px solid #b7f7c8; padding:12px; border-radius:10px; margin-top:14px; }
    .totalNum { font-size:22px; font-weight:bold; }
    .mini { font-size:12px; opacity:.7; margin-top:4px; }
  </style>
</head>

<body>

  <h1>üßæ Captura de Reporte Diario</h1>
  <div class="muted" id="infoUser">Cargando usuario...</div>

  <div class="box">
    <div class="row">
      <div class="col">
        <label>Fecha</label>
        <input type="date" id="fecha">
      </div>

      <div class="col">
        <label>Turno</label>
        <select id="turno">
          <option value="1">Turno 1</option>
          <option value="2">Turno 2</option>
        </select>
        <div class="muted" id="turnoHelp"></div>
      </div>

      <div class="col" id="tiendaBox">
        <label>Tienda</label>
        <select id="id_tienda"></select>
        <div class="muted" id="tiendaHelp"></div>
      </div>
    </div>

    <hr style="margin:14px 0; border-color:#eee;">

    <div class="row">
      <div class="col">
        <label>Efectivo</label>
        <input type="number" id="efectivo" value="0" step="0.01">
      </div>

      <div class="col">
        <label>Transferencia</label>
        <input type="number" id="transferencia" value="0" step="0.01">
      </div>

      <div class="col">
        <label>Terminal 1</label>
        <input type="number" id="terminal1" value="0" step="0.01">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Terminal 2</label>
        <input type="number" id="terminal2" value="0" step="0.01">
      </div>

      <div class="col">
        <label>Gastos</label>
        <input type="number" id="gastos" value="0" step="0.01">
      </div>

      <div class="col">
        <label>Retiro</label>
        <input type="number" id="retiro" value="0" step="0.01">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Fondo inicial</label>
        <input type="number" id="fondo_inicial" value="0" step="0.01">
      </div>

      <div class="col">
        <label>Total (calculado)</label>
        <div class="totalBox">
          <div class="totalNum" id="total">$0.00</div>
          <div class="mini">Total = efectivo + transferencia + terminal1 + terminal2 - gastos - retiro</div>
        </div>
      </div>
    </div>

    <button onclick="guardar()">üíæ Guardar captura</button>
  </div>

  <div class="box">
    <h3>Respuesta</h3>
    <pre id="out">{}</pre>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  console.log("CAPTURA 2B CARGADA");
  console.log("TOKEN:", localStorage.getItem("token"));

  function hoyISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function getToken() {
    return localStorage.getItem('token');
  }

  function getUser() {
    const raw = localStorage.getItem('usuario');
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function validarLogin() {
    const token = getToken();
    if (!token) {
      alert("No has iniciado sesi√≥n");
      window.location.href = "/login.html";
      return false;
    }
    return true;
  }

  function setInfoUsuario() {
    const u = getUser();
    if (!u) {
      $('infoUser').innerHTML = `<span class="danger">‚ö†Ô∏è No hay info de usuario guardada (solo token). Corrige login.html</span>`;
      return;
    }

    $('infoUser').textContent =
      `Usuario: ${u.nombre} (${u.usuario}) | Rol: ${u.rol} | Tienda: ${u.id_tienda ?? 'GLOBAL'}`;
  }

  function num(id){
    const v = parseFloat($(id).value);
    return isNaN(v) ? 0 : v;
  }

  function money(n){
    return "$" + (n || 0).toFixed(2);
  }

  function recalcularTotal(){
    const total =
      num("efectivo") +
      num("transferencia") +
      num("terminal1") +
      num("terminal2") -
      num("gastos") -
      num("retiro");

    $("total").textContent = money(total);
  }

  function ajustarTurnoSegunFecha(){
    const f = $("fecha").value;
    if(!f) return;

    if(f === hoyISO()){
      const h = new Date().getHours();
      const turnoAuto = (h < 16) ? "1" : "2"; // ajustable
      $("turno").value = turnoAuto;
      $("turno").disabled = true;
      $("turnoHelp").textContent = "Hoy: turno autom√°tico seg√∫n la hora.";
    } else {
      $("turno").disabled = false;
      $("turnoHelp").textContent = "Fecha pasada: turno manual.";
    }
  }

  async function cargarTiendas() {
    const token = getToken();

    const res = await fetch('/api/tiendas', {
      headers: { 'Authorization': 'Bearer ' + token }
    });

    const json = await res.json();

    if (!json.ok) {
      alert(json.mensaje || json.error || 'Error cargando tiendas');
      return;
    }

    $('id_tienda').innerHTML = '';

    json.tiendas.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id_tienda;
      opt.textContent = `${t.id_tienda} - ${t.nombre}`;
      $('id_tienda').appendChild(opt);
    });
  }

  function aplicarPermisosTienda(){
    const u = getUser();
    if(!u) return;

    // ADMIN: puede elegir tienda
    if(u.rol === "ADMIN"){
      $("id_tienda").disabled = false;
      $("tiendaHelp").textContent = "ADMIN: puedes capturar para cualquier tienda.";
      return;
    }

    // TIENDA: se bloquea y se fuerza su tienda
    $("id_tienda").disabled = true;
    $("tiendaHelp").textContent = "TIENDA: captura exclusiva de tu tienda.";

    // Forzar valor
    if(u.id_tienda){
      $("id_tienda").value = String(u.id_tienda);
    }
  }

  async function guardar() {
    if (!validarLogin()) return;

    const token = getToken();
    const u = getUser();

    const body = {
      fecha: $('fecha').value,
      turno: Number($('turno').value),
      id_tienda: Number($('id_tienda').value),

      efectivo: num('efectivo'),
      transferencia: num('transferencia'),
      terminal1: num('terminal1'),
      terminal2: num('terminal2'),
      gastos: num('gastos'),
      retiro: num('retiro'),
      fondo_inicial: num('fondo_inicial'),

      total: (
        num("efectivo") +
        num("transferencia") +
        num("terminal1") +
        num("terminal2") -
        num("gastos") -
        num("retiro")
      )
    };

    if (!body.fecha || !body.id_tienda || !body.turno) {
      alert("Falta fecha, tienda o turno");
      return;
    }

    // seguridad extra: si no es admin, forzar id_tienda desde usuario
    if(u && u.rol !== "ADMIN"){
      body.id_tienda = Number(u.id_tienda);
    }

    const res = await fetch('/api/reportes', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify(body)
    });

    const json = await res.json();
    $('out').textContent = JSON.stringify(json, null, 2);

    if (json.ok) {
      alert("‚úÖ Captura guardada");
    } else {
      // Mensaje especial duplicado (lo haremos en backend)
      if(json.code === "DUPLICADO"){
        alert("‚ö†Ô∏è Ya existe captura para este turno");
      } else {
        alert("‚ùå " + (json.mensaje || json.error || "Error"));
      }
    }
  }

  // INIT
  $('fecha').value = hoyISO();
  ajustarTurnoSegunFecha();
  recalcularTotal();

  $("fecha").addEventListener("change", () => {
    ajustarTurnoSegunFecha();
  });

  ["efectivo","transferencia","terminal1","terminal2","gastos","retiro","fondo_inicial"]
    .forEach(id => $(id).addEventListener("input", recalcularTotal));

  if (validarLogin()) {
    setInfoUsuario();

    cargarTiendas().then(() => {
      aplicarPermisosTienda();
    });
  }
</script>

</body>
</html>
