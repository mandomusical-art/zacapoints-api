<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cambiar contrase√±a ‚Ä¢ Zacapoints</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f4f6f9;
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
    }
    .card{
      width:100%;
      max-width:420px;
      background:white;
      border-radius:14px;
      padding:24px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
    }
    h2{
      margin:0 0 10px 0;
      font-size:22px;
    }
    .hint{
      margin:0 0 16px 0;
      font-size:13px;
      color:#555;
      line-height:1.4;
    }
    label{
      display:block;
      font-size:14px;
      margin:10px 0 6px;
      color:#333;
    }
    input{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid #ddd;
      font-size:16px;
      outline:none;
      box-sizing:border-box;
    }
    input:focus{
      border-color:#222;
    }
    button{
      width:100%;
      margin-top:16px;
      padding:12px;
      border:none;
      border-radius:10px;
      background:#111;
      color:white;
      font-size:16px;
      cursor:pointer;
    }
    button:hover{ opacity:.92; }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .small{
      margin-top:12px;
      font-size:12px;
      color:#666;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>üîÅ Cambiar contrase√±a</h2>

    <p class="hint">
      Por seguridad, debes actualizar tu contrase√±a antes de continuar.
    </p>

    <label for="actual">Contrase√±a actual</label>
    <input id="actual" type="password" placeholder="password actual" autocomplete="current-password" />

    <label for="nueva">Nueva contrase√±a</label>
    <input id="nueva" type="password" placeholder="nueva password" autocomplete="new-password" />

    <label for="confirmar">Confirmar nueva contrase√±a</label>
    <input id="confirmar" type="password" placeholder="confirmar password" autocomplete="new-password" />

    <button id="btn" onclick="cambiarPassword()">Guardar</button>

    <div class="small">Zacapoints ‚Ä¢ Seguridad activa</div>
  </div>

<script>
function getToken() {
  return localStorage.getItem("token");
}

function logoutForzado() {
  localStorage.removeItem("token");
  localStorage.removeItem("usuario");
  window.location.href = "/index.html";
}

async function cambiarPassword() {
  const password_actual = document.getElementById("actual").value;
  const password_nueva = document.getElementById("nueva").value;
  const confirmar = document.getElementById("confirmar").value;

  if (!password_actual || !password_nueva || !confirmar) {
    alert("Completa todos los campos");
    return;
  }

  if (password_nueva.length < 4) {
    alert("La nueva contrase√±a es muy corta (m√≠nimo 4 caracteres)");
    return;
  }

  if (password_nueva !== confirmar) {
    alert("La nueva contrase√±a no coincide");
    return;
  }

  const token = getToken();
  if (!token) {
    alert("Sesi√≥n no v√°lida. Vuelve a iniciar sesi√≥n.");
    logoutForzado();
    return;
  }

  const btn = document.getElementById("btn");
  btn.disabled = true;
  btn.textContent = "Guardando...";

  try {
    const res = await fetch("/api/auth/cambiar-password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ password_actual, password_nueva })
    });

    const json = await res.json();

    if (!res.ok || !json.ok) {
      alert(json.mensaje || json.error || "No se pudo cambiar la contrase√±a");
      return;
    }

    // Si quieres, aqu√≠ puedes refrescar el usuario guardado:
    // (opcional, porque el backend no devuelve usuario)
    // const u = JSON.parse(localStorage.getItem("usuario") || "{}");
    // u.debe_cambiar_password = false;
    // localStorage.setItem("usuario", JSON.stringify(u));

    alert("Contrase√±a actualizada. Ahora puedes continuar.");

    // V√°monos al dashboard
    window.location.href = "/dashboard.html";

  } catch (err) {
    console.error(err);
    alert("No se pudo conectar al servidor");
  } finally {
    btn.disabled = false;
    btn.textContent = "Guardar";
  }
}

// Blindaje: si no hay token, no deber√≠a estar aqu√≠
(function init(){
  const token = getToken();
  if (!token) {
    logoutForzado();
    return;
  }
})();
</script>

</body>
</html>
